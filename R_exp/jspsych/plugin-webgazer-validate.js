var jsPsychWebgazerValidate=function(t){"use strict";const e={name:"webgazer-validate",parameters:{validation_points:{type:t.ParameterType.INT,default:[[10,10],[10,50],[10,90],[50,10],[50,50],[50,90],[90,10],[90,50],[90,90]],array:!0},validation_point_coordinates:{type:t.ParameterType.SELECT,default:"percent",options:["percent","center-offset-pixels"]},roi_radius:{type:t.ParameterType.INT,default:200},randomize_validation_order:{type:t.ParameterType.BOOL,default:!1},time_to_saccade:{type:t.ParameterType.INT,default:1e3},validation_duration:{type:t.ParameterType.INT,default:2e3},point_size:{type:t.ParameterType.INT,default:20},show_validation_data:{type:t.ParameterType.BOOL,default:!1}}};class i{constructor(t){this.jsPsych=t}trial(t,e){function i(t,i){return"percent"==e.validation_point_coordinates?a(t,i):"center-offset-pixels"==e.validation_point_coordinates?n(t,i):void 0}function a(t,i){return`<div class="validation-point" style="width:${e.point_size}px; height:${e.point_size}px; border-radius:${e.point_size}px; border: 1px solid #000; background-color: #333; position: absolute; left:${t}%; top:${i}%;"></div>`}function n(t,i){return`<div class="validation-point" style="width:${e.point_size}px; height:${e.point_size}px; border-radius:${e.point_size}px; border: 1px solid #000; background-color: #333; position: absolute; left:calc(50% - ${e.point_size/2}px + ${t}px); top:calc(50% - ${e.point_size/2}px + ${i}px);"></div>`}function o(t,i,a,n,o){return"percent"==e.validation_point_coordinates?r(t,i,a,n,o):"center-offset-pixels"==e.validation_point_coordinates?s(t,i,a,n,o):void 0}function r(t,e,i,a,n){return`\n          <div class="validation-centroid" style="width:${2*n}px; height:${2*n}px; border: 2px dotted #ccc; border-radius: ${n}px; background-color: transparent; position: absolute; left:calc(${t}% + ${i-n}px); top:calc(${e}% + ${a-n}px);"></div>\n        `}function s(t,e,i,a,n){return`\n          <div class="validation-centroid" style="width:${2*n}px; height:${2*n}px; border: 2px dotted #ccc; border-radius: ${n}px; background-color: transparent; position: absolute; left:calc(50% + ${t}px + ${i-n}px); top:calc(50% + ${e}px + ${a-n}px);"></div>\n        `}function d(t,i,a,n){return"percent"==e.validation_point_coordinates?p(t,i,a,n):"center-offset-pixels"==e.validation_point_coordinates?l(t,i,a,n):void 0}function p(t,i,a,n){return`<div class="raw-data-point" style="width:5px; height:5px; border-radius:5px; background-color: ${Math.sqrt(a*a+n*n)<=e.roi_radius?"#afa":"#faa"}; opacity:0.8; position: absolute; left:calc(${t}% + ${a-2}px); top:calc(${i}% + ${n-2}px);"></div>`}function l(t,i,a,n){return`<div class="raw-data-point" style="width:5px; height:5px; border-radius:5px; background-color: ${Math.sqrt(a*a+n*n)<=e.roi_radius?"#afa":"#faa"}; opacity:0.8; position: absolute; left:calc(50% + ${t}px + ${a-2}px); top:calc(50% + ${i}px + ${n-2}px);"></div>`}function c(t){var e=Math.floor(t.length/2),i=t.sort((t,e)=>t-e);return t.length%2==0?i[e-1]+i[e]/2:i[e]}function u(t){var e=t.reduce((e,i,a)=>(e+=i.dx,a==t.length-1?e/t.length:e),0),i=t.reduce((e,i,a)=>(e+=i.dy,a==t.length-1?e/t.length:e),0),a=c(t.map(t=>Math.sqrt(Math.pow(t.dx-e,2)+Math.pow(t.dy-i,2))));return{x:e,y:i,r:a}}function h(t){return t.map(t=>Math.sqrt(Math.pow(t.dx,2)+Math.pow(t.dy,2))).reduce((t,i)=>(i<=e.roi_radius&&t++,t),0)/t.length*100}function v(t){var e=[];if(0==t.length)return 0;for(var i=0;i<t.length;i++)if(t[i].length>1){for(var a=[],n=1;n<t[i].length;n++)a.push(t[i][n].t-t[i][n-1].t);e.push(a.reduce((t,e)=>t+e,0)/a.length)}return e.length>0?1e3/(e.reduce((t,e)=>t+e,0)/e.length):null}var _={raw_gaze:[],percent_in_roi:[],average_offset:[],validation_points:null},f="\n        <div id='webgazer-validate-container' style='position: relative; width:100vw; height:100vh; overflow: hidden;'>\n        </div>";t.innerHTML=f;var x=t.querySelector("#webgazer-validate-container"),g=-1,y=null,w=performance.now();const b=()=>{this.jsPsych.extensions.webgazer.stopSampleInterval(),this.jsPsych.pluginAPI.clearAllTimeouts(),t.innerHTML="",this.jsPsych.finishTrial(_)},$=t=>{var a=i(t[0],t[1]);x.innerHTML=a;var n=x.querySelector(".validation-point").getBoundingClientRect(),o=n.left+n.width/2,r=n.top+n.height/2,s=performance.now()+e.time_to_saccade,d=s+e.validation_duration,p=[],l=this.jsPsych.extensions.webgazer.onGazeUpdate(t=>{performance.now()>s&&p.push({x:t.x,y:t.y,dx:t.x-o,dy:t.y-r,t:Math.round(t.t-w)})});requestAnimationFrame(function t(){performance.now()<d?requestAnimationFrame(t):(_.raw_gaze.push(p),l(),z())})},z=()=>{if(++g==y.length)P();else{var t=y[g];$(t)}},m=()=>{for(var t="",a=0;a<e.validation_points.length;a++){t+=i(e.validation_points[a][0],e.validation_points[a][1]),t+=o(e.validation_points[a][0],e.validation_points[a][1],0,0,e.roi_radius);for(var n=0;n<_.raw_gaze[a].length;n++)t+=d(e.validation_points[a][0],e.validation_points[a][1],_.raw_gaze[a][n].dx,_.raw_gaze[a][n].dy)}t+='<button id="cont" style="position:absolute; top: 50%; left:calc(50% - 50px); width: 100px;" class="jspsych-btn">Continue</btn>',x.innerHTML=t,x.querySelector("#cont").addEventListener("click",()=>{this.jsPsych.extensions.webgazer.pause(),b()}),this.jsPsych.extensions.webgazer.showPredictions(),this.jsPsych.extensions.webgazer.stopSampleInterval(),this.jsPsych.extensions.webgazer.resume()},P=()=>{_.samples_per_sec=v(_.raw_gaze).toFixed(2);for(var t=0;t<e.validation_points.length;t++)_.percent_in_roi[t]=h(_.raw_gaze[t]),_.average_offset[t]=u(_.raw_gaze[t]);e.show_validation_data?m():b()};(()=>{y=e.randomize_validation_order?this.jsPsych.randomization.shuffle(e.validation_points):e.validation_points,_.validation_points=y,g=-1,this.jsPsych.extensions.webgazer.startSampleInterval(),z()})()}}return i.info=e,i}(jsPsychModule);